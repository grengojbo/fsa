# -*- mode: python; coding: utf-8; -*-
"""
This file demonstrates two different styles of tests (one doctest and one
unittest). These will both pass when you run "manage.py test".

Replace these with more appropriate tests for your application.
"""

__author__ = '$Author:$'
__revision__ = '$Revision:$'

from django import test
from django.test.client import Client
from django.contrib.auth.models import User
from django.contrib.auth.models import Permission
from fsa.server.models import Server
from fsa.core import is_app
import os, os.path
import urllib, base64
import logging as log
from decimal import Decimal
import keyedcache

class CdrTestCase(test.TestCase):
    if is_app('fsb.tariff'):
        fixtures = ['testsite', 'testnp', 'acl', 'alias', 'extension', 'context', 'server', 'server_conf', 'test_gateway', 'sipprofile', 'tariffplan']
    else:
        fixtures = ['testsite', 'testnp', 'acl', 'alias', 'extension', 'context', 'server', 'server_conf', 'test_gateway', 'sipprofile']

    def setUp(self):
        # Every test needs a client.
        self.user = User.objects.create_user('test', 'test@test.com', 'test')
        self.user2 = User.objects.create_user('test2', 'test@test.com', 'test2')
        self.user.is_staff = True
        self.user.is_superuser = True
        self.user.is_active = True
        self.user.save()
        self.user2.is_active = True
        self.user2.save()
        self.auth_string = 'Basic %s' % base64.encodestring('test:test').rstrip()
        self.auth_string2 = 'Basic %s' % base64.encodestring('test2:test2').rstrip()
        self.auth_string3 = 'Basic %s' % base64.encodestring('test2:test').rstrip()
        self.client = Client()
        self.serv_name = 'test1.example.com'
        fin1 = os.path.join(os.path.dirname(__file__), './fixtures/1in.cdr.xml')
        fout1 = os.path.join(os.path.dirname(__file__), './fixtures/1out.cdr.xml')
        fin = open(fin1, "r+")
        self.cdr1 = urllib.unquote(fin.read())
        fin.close()
        fout = open(fout1, "r+")
        self.cdr2 = urllib.unquote(fout.read())
        fout.close()

    
    def testCdrConf(self):
        es = Server.objects.get(name=self.serv_name, enabled=True)
        s = es.options['xml_cdr']
        self.assertEquals(s.lighttpd.value, True)
    
    def testCdr(self):
        """
        Tests load and parse xml cdr
        """
        # TODO: подобавлять проверки добавяемыз значений
        #log.debug(self.cdr1)
        response = self.client.post('/api/cdr/', {'cdr': self.cdr1}, HTTP_AUTHORIZATION=self.auth_string)
        #log.debug(response)
        self.failUnlessEqual(response.status_code, 200)
        response = self.client.post('/api/cdr/', {'cdr': '<?xml version="1.0"?><cdr>  <variables>    <sip_received_ip>10.10.10.10</sip_received_ip>\n    <sip_received_port>25710</sip_received_port>\n    <sip_via_protocol>udp</sip_via_protocol>\n    <sip_authorized>true</sip_authorized>\n    <sip_mailbox>1017</sip_mailbox>\n    <sip_auth_username>1017</sip_auth_username>\n    <sip_auth_realm>62.149.27.151</sip_auth_realm>\n    <mailbox>1017</mailbox>\n    <toll_allow>domestic,international,local</toll_allow>\n    <accountcode>1017</accountcode>\n    <user_context>default</user_context>\n    <effective_caller_id_name>Extension 1017</effective_caller_id_name>\n    <effective_caller_id_number>1017</effective_caller_id_number>\n    <outbound_caller_id_name>FreeSWITCH</outbound_caller_id_name>\n    <outbound_caller_id_number>0000000000</outbound_caller_id_number>\n    <callgroup>techsupport</callgroup>\n    <sip_from_user>1017</sip_from_user>\n    <sip_from_uri>1017@62.149.27.151</sip_from_uri>\n    <sip_from_host>62.149.27.151</sip_from_host>\n    <sip_from_user_stripped>1017</sip_from_user_stripped>\n    <sip_from_tag>39498d03</sip_from_tag>\n    <sofia_profile_name>internal</sofia_profile_name>\n    <sip_req_user>1015</sip_req_user>\n    <sip_req_uri>1015@62.149.27.151</sip_req_uri>\n    <sip_req_host>62.149.27.151</sip_req_host>\n    <sip_to_user>1015</sip_to_user>\n    <sip_to_uri>1015@62.149.27.151</sip_to_uri>\n    <sip_to_host>62.149.27.151</sip_to_host>\n    <sip_contact_user>1017</sip_contact_user>\n    <sip_contact_port>25710</sip_contact_port>\n    <sip_contact_uri>1017@77.122.2.96:25710</sip_contact_uri>\n    <sip_contact_host>77.122.2.96</sip_contact_host>\n    <channel_name>sofia/internal/1017@62.149.27.151</channel_name>\n    <sip_call_id>NmZmYjliN2IzYTU1M2IwYjYzMTg0Njk1MmY3MWQzNTc.</sip_call_id>\n    <sip_via_host>77.122.2.96</sip_via_host>\n    <sip_via_port>25710</sip_via_port>\n    <sip_via_rport>25710</sip_via_rport>\n    <max_forwards>70</max_forwards>\n    <presence_id>1017@62.149.27.151</presence_id>\n    <switch_r_sdp>v=0\r\no=- 2 2 IN IP4 77.122.2.96\r\ns=CounterPath X-Lite 3.0\r\nc=IN IP4 77.122.2.96\r\nt=0 0\r\nm=audio 40462 RTP/AVP 107 119 100 106 0 105 98 8 3 101\r\na=rtpmap:107 BV32/16000\r\na=rtpmap:119 BV32-FEC/16000\r\na=rtpmap:100 SPEEX/16000\r\na=rtpmap:106 SPEEX-FEC/16000\r\na=rtpmap:105 SPEEX-FEC/8000\r\na=rtpmap:98 iLBC/8000\r\na=rtpmap:101 telephone-event/8000\r\na=fmtp:101 0-15\r\na=alt:1 1 : Xkorc1Eg 98LTGk26 77.122.2.96 40462\r\n</switch_r_sdp>\n    <use_profile>default</use_profile>\n    <record_stereo>true</record_stereo>\n    <transfer_fallback_extension>operator</transfer_fallback_extension>\n    <numbering_plan>US</numbering_plan>\n    <default_areacode>918</default_areacode>\n    <default_gateway>217.69.172.139</default_gateway>\n    <user_name>default</user_name>\n    <domain_name>62.149.27.151</domain_name>\n    <dialed_extension>1015</dialed_extension>\n    <export_vars>dialed_extension</export_vars>    <ringback>%(2000, 4000, 440.0, 480.0)</ringback>\n    <transfer_ringback>local_stream://moh</transfer_ringback>\n    <call_timeout>30</call_timeout>\n    <hangup_after_bridge>true</hangup_after_bridge>\n    <continue_on_fail>true</continue_on_fail>\n    <called_party_callgroup>techsupport</called_party_callgroup>\n    <dialed_user>1015</dialed_user>\n    <dialed_domain>62.149.27.151</dialed_domain>\n    <originate_disposition>USER_NOT_REGISTERED</originate_disposition>\n    <remote_media_ip>77.122.2.96</remote_media_ip>\n    <remote_media_port>40462</remote_media_port>\n    <write_codec>PCMU</write_codec>\n    <write_rate>8000</write_rate>\n    <local_media_ip>62.149.27.151</local_media_ip>\n    <local_media_port>23182</local_media_port>\n    <endpoint_disposition>ANSWER</endpoint_disposition>\n    <current_application_data>default 62.149.27.151 1015</current_application_data>\n    <current_application>voicemail</current_application>\n    <read_codec>PCMU</read_codec>\n    <read_rate>8000</read_rate>\n    <sip_user_agent>X-Lite release 1100l stamp 47546</sip_user_agent>\n    <sip_hangup_disposition>recv_bye</sip_hangup_disposition>\n    <sip_term_status>200</sip_term_status>\n    <proto_specific_hangup_cause>sip:200</proto_specific_hangup_cause>\n    <sip_term_cause>16</sip_term_cause>\n    <hangup_cause>NORMAL_CLEARING</hangup_cause>\n    <start_stamp>2009-02-23 23:15:08</start_stamp>\n    <profile_start_stamp>2009-02-23 23:15:08</profile_start_stamp>\n    <answer_stamp>2009-02-23 23:15:08</answer_stamp>\n    <progress_media_stamp>2009-02-23 23:15:08</progress_media_stamp>\n    <end_stamp>2009-02-23 23:15:30</end_stamp>\n    <start_epoch>1235423708</start_epoch>\n    <start_uepoch>1235423708386866</start_uepoch>\n    <profile_start_epoch>1235423708</profile_start_epoch>\n    <profile_start_uepoch>1235423708386866</profile_start_uepoch>\n    <answer_epoch>1235423708</answer_epoch>\n    <answer_uepoch>1235423708844601</answer_uepoch>\n    <progress_epoch>0</progress_epoch>\n    <progress_uepoch>0</progress_uepoch>\n    <progress_media_epoch>1235423708</progress_media_epoch>\n    <progress_media_uepoch>1235423708842794</progress_media_uepoch>\n    <end_epoch>1235423730</end_epoch>\n    <end_uepoch>1235423730722010</end_uepoch>\n    <last_app>voicemail</last_app>\n    <last_arg>default 62.149.27.151 1015</last_arg>\n    <caller_id>"1017" <1017></caller_id>\n    <duration>22</duration>\n    <billsec>22</billsec>\n    <progresssec>0</progresssec>\n    <progress_mediasec>0</progress_mediasec>\n    <flow_billsec>22</flow_billsec>\n    <mduration>22336</mduration>\n    <billmsec>21878</billmsec>\n    <progressmsec>0</progressmsec>\n    <progress_mediamsec>0</progress_mediamsec>\n    <flow_billmsec>22336</flow_billmsec>\n    <uduration>22335144</uduration>\n    <billusec>21877409</billusec>\n    <progressusec>0</progressusec>\n    <progress_mediausec>455928</progress_mediausec>\n    <flow_billusec>22335144</flow_billusec>\n    <sound_prefix>/usr/local/freeswitch/sounds/en/us/callie</sound_prefix>\n  </variables>\n  <app_log>\n    <application app_name="set" app_data="use_profile=default"></application>\n    <application app_name="set_user" app_data="default@62.149.27.151"></application>\n    <application app_name="info" app_data=""></application>\n    <application app_name="db" app_data="insert/62.149.27.151-spymap/1017/0c5bfef0-01ef-11de-ba5a-936aee2cf265"></application>\n    <application app_name="db" app_data="insert/62.149.27.151-last_dial/1017/1015"></application>\n    <application app_name="db" app_data="insert/62.149.27.151-last_dial/global/0c5bfef0-01ef-11de-ba5a-936aee2cf265"></application>\n    <application app_name="set" app_data="dialed_extension=1015"></application>\n    <application app_name="export" app_data="dialed_extension=1015"></application>\n    <application app_name="bind_meta_app" app_data="1 b s execute_extension::dx XML features"></application>\n    <application app_name="bind_meta_app" app_data="2 b s record_session::/usr/local/freeswitch/recordings/1017.2009-02-23-23-15-08.wav"></application>\n    <application app_name="bind_meta_app" app_data="3 b s execute_extension::cf XML features"></application>\n    <application app_name="set" app_data="ringback=%(2000, 4000, 440.0, 480.0)"></application>\n    <application app_name="set" app_data="transfer_ringback=local_stream://moh"></application>\n    <application app_name="set" app_data="call_timeout=30"></application>\n    <application app_name="set" app_data="hangup_after_bridge=true"></application>\n    <application app_name="set" app_data="continue_on_fail=true"></application>\n    <application app_name="db" app_data="insert/62.149.27.151-call_return/1015/1017"></application>\n    <application app_name="db" app_data="insert/62.149.27.151-last_dial_ext/1015/0c5bfef0-01ef-11de-ba5a-936aee2cf265"></application>\n    <application app_name="set" app_data="called_party_callgroup=techsupport"></application>\n    <application app_name="db" app_data="insert/62.149.27.151-last_dial/techsupport/0c5bfef0-01ef-11de-ba5a-936aee2cf265"></application>\n    <application app_name="bridge" app_data="user/1015@62.149.27.151"></application>\n    <application app_name="answer" app_data=""></application>\n    <application app_name="sleep" app_data="1000"></application>\n    <application app_name="voicemail" app_data="default 62.149.27.151 1015"></application>\n  </app_log>\n  <callflow dialplan="XML" profile_index="1">\n    <extension name="global" number="1015">\n      <application app_name="set" app_data="use_profile=${cond(${acl(${network_addr} rfc1918)} == true ? nat : default)}"></application>\n      <application app_name="set_user" app_data="default@${domain_name}"></application>\n      <application app_name="info" app_data=""></application>\n      <application app_name="db" app_data="insert/${domain_name}-spymap/${caller_id_number}/${uuid}"></application>\n      <application app_name="db" app_data="insert/${domain_name}-last_dial/${caller_id_number}/${destination_number}"></application>\n      <application app_name="db" app_data="insert/${domain_name}-last_dial/global/${uuid}"></application>\n      <application app_name="set" app_data="dialed_extension=1015"></application>\n      <application app_name="export" app_data="dialed_extension=1015"></application>\n      <application app_name="bind_meta_app" app_data="1 b s execute_extension::dx XML features"></application>\n      <application app_name="bind_meta_app" app_data="2 b s record_session::/usr/local/freeswitch/recordings/${caller_id_number}.${strftime(%Y-%m-%d-%H-%M-%S)}.wav"></application>\n      <application app_name="bind_meta_app" app_data="3 b s execute_extension::cf XML features"></application>\n      <application app_name="set" app_data="ringback=${us-ring}"></application>\n      <application app_name="set" app_data="transfer_ringback=local_stream://moh"></application>\n      <application app_name="set" app_data="call_timeout=30"></application>\n      <application app_name="set" app_data="hangup_after_bridge=true"></application>\n      <application app_name="set" app_data="continue_on_fail=true"></application>\n      <application app_name="db" app_data="insert/${domain_name}-call_return/${dialed_extension}/${caller_id_number}"></application>\n      <application app_name="db" app_data="insert/${domain_name}-last_dial_ext/${dialed_extension}/${uuid}"></application>\n      <application app_name="set" app_data="called_party_callgroup=${user_data(${dialed_extension}@${domain_name} var callgroup)}"></application>\n      <application app_name="db" app_data="insert/${domain_name}-last_dial/${called_party_callgroup}/${uuid}"></application>\n      <application app_name="bridge" app_data="user/${dialed_extension}@${domain_name}"></application>\n      <application app_name="answer" app_data=""></application>\n      <application app_name="sleep" app_data="1000"></application>\n      <application app_name="voicemail" app_data="default ${domain_name} ${dialed_extension}"></application>\n    </extension>\n    <caller_profile>\n      <username>1017</username>\n      <dialplan>XML</dialplan>\n      <caller_id_name>1017</caller_id_name>\n      <ani></ani>\n      <aniii></aniii>\n      <caller_id_number>1017</caller_id_number>\n      <network_addr>77.122.2.96</network_addr>\n      <rdnis></rdnis>\n      <destination_number>1015</destination_number>\n      <uuid>0c5bfef0-01ef-11de-ba5a-936aee2cf265</uuid>\n      <source>mod_sofia</source>\n      <context>default</context>\n      <chan_name>sofia/internal/1017@62.149.27.151</chan_name>\n    </caller_profile>\n    <times>\n      <created_time>1235423708386866</created_time>\n      <profile_created_time>1235423708386866</profile_created_time>\n      <progress_time>0</progress_time>\n      <progress_media_time>1235423708842794</progress_media_time>\n      <answered_time>1235423708844601</answered_time>\n      <hangup_time>1235423730722010</hangup_time>\n      <transfer_time>0</transfer_time>\n    </times>\n  </callflow></cdr>'}, HTTP_AUTHORIZATION=self.auth_string2)
        self.failUnlessEqual(response.status_code, 401)

        perm = Permission.objects.get(codename='add_cdr')
        self.user2.user_permissions.add(perm)
        self.user2.save()
        response = self.client.post('/api/cdr/', {'cdr': '<?xml version="1.0"?><cdr>  <variables>    <sip_received_ip>10.10.10.10\n    <sip_received_port>25710</sip_received_port>\n    <sip_via_protocol>udp</sip_via_protocol>\n    <sip_authorized>true</sip_authorized>\n    <sip_mailbox>1017</sip_mailbox>\n    <sip_auth_username>1017</sip_auth_username>\n    <sip_auth_realm>62.149.27.151</sip_auth_realm>\n    <mailbox>1017</mailbox>\n    <toll_allow>domestic,international,local</toll_allow>\n    <accountcode>1017</accountcode>\n    <user_context>default</user_context>\n    <effective_caller_id_name>Extension 1017</effective_caller_id_name>\n    <effective_caller_id_number>1017</effective_caller_id_number>\n    <outbound_caller_id_name>FreeSWITCH</outbound_caller_id_name>\n    <outbound_caller_id_number>0000000000</outbound_caller_id_number>\n    <callgroup>techsupport</callgroup>\n    <sip_from_user>1017</sip_from_user>\n    <sip_from_uri>1017@62.149.27.151</sip_from_uri>\n    <sip_from_host>62.149.27.151</sip_from_host>\n    <sip_from_user_stripped>1017</sip_from_user_stripped>\n    <sip_from_tag>39498d03</sip_from_tag>\n    <sofia_profile_name>internal</sofia_profile_name>\n    <sip_req_user>1015</sip_req_user>\n    <sip_req_uri>1015@62.149.27.151</sip_req_uri>\n    <sip_req_host>62.149.27.151</sip_req_host>\n    <sip_to_user>1015</sip_to_user>\n    <sip_to_uri>1015@62.149.27.151</sip_to_uri>\n    <sip_to_host>62.149.27.151</sip_to_host>\n    <sip_contact_user>1017</sip_contact_user>\n    <sip_contact_port>25710</sip_contact_port>\n    <sip_contact_uri>1017@77.122.2.96:25710</sip_contact_uri>\n    <sip_contact_host>77.122.2.96</sip_contact_host>\n    <channel_name>sofia/internal/1017@62.149.27.151</channel_name>\n    <sip_call_id>NmZmYjliN2IzYTU1M2IwYjYzMTg0Njk1MmY3MWQzNTc.</sip_call_id>\n    <sip_via_host>77.122.2.96</sip_via_host>\n    <sip_via_port>25710</sip_via_port>\n    <sip_via_rport>25710</sip_via_rport>\n    <max_forwards>70</max_forwards>\n    <presence_id>1017@62.149.27.151</presence_id>\n    <switch_r_sdp>v=0\r\no=- 2 2 IN IP4 77.122.2.96\r\ns=CounterPath X-Lite 3.0\r\nc=IN IP4 77.122.2.96\r\nt=0 0\r\nm=audio 40462 RTP/AVP 107 119 100 106 0 105 98 8 3 101\r\na=rtpmap:107 BV32/16000\r\na=rtpmap:119 BV32-FEC/16000\r\na=rtpmap:100 SPEEX/16000\r\na=rtpmap:106 SPEEX-FEC/16000\r\na=rtpmap:105 SPEEX-FEC/8000\r\na=rtpmap:98 iLBC/8000\r\na=rtpmap:101 telephone-event/8000\r\na=fmtp:101 0-15\r\na=alt:1 1 : Xkorc1Eg 98LTGk26 77.122.2.96 40462\r\n</switch_r_sdp>\n    <use_profile>default</use_profile>\n    <record_stereo>true</record_stereo>\n    <transfer_fallback_extension>operator</transfer_fallback_extension>\n    <numbering_plan>US</numbering_plan>\n    <default_areacode>918</default_areacode>\n    <default_gateway>217.69.172.139</default_gateway>\n    <user_name>default</user_name>\n    <domain_name>62.149.27.151</domain_name>\n    <dialed_extension>1015</dialed_extension>\n    <export_vars>dialed_extension</export_vars>    <ringback>%(2000, 4000, 440.0, 480.0)</ringback>\n    <transfer_ringback>local_stream://moh</transfer_ringback>\n    <call_timeout>30</call_timeout>\n    <hangup_after_bridge>true</hangup_after_bridge>\n    <continue_on_fail>true</continue_on_fail>\n    <called_party_callgroup>techsupport</called_party_callgroup>\n    <dialed_user>1015</dialed_user>\n    <dialed_domain>62.149.27.151</dialed_domain>\n    <originate_disposition>USER_NOT_REGISTERED</originate_disposition>\n    <remote_media_ip>77.122.2.96</remote_media_ip>\n    <remote_media_port>40462</remote_media_port>\n    <write_codec>PCMU</write_codec>\n    <write_rate>8000</write_rate>\n    <local_media_ip>62.149.27.151</local_media_ip>\n    <local_media_port>23182</local_media_port>\n    <endpoint_disposition>ANSWER</endpoint_disposition>\n    <current_application_data>default 62.149.27.151 1015</current_application_data>\n    <current_application>voicemail</current_application>\n    <read_codec>PCMU</read_codec>\n    <read_rate>8000</read_rate>\n    <sip_user_agent>X-Lite release 1100l stamp 47546</sip_user_agent>\n    <sip_hangup_disposition>recv_bye</sip_hangup_disposition>\n    <sip_term_status>200</sip_term_status>\n    <proto_specific_hangup_cause>sip:200</proto_specific_hangup_cause>\n    <sip_term_cause>16</sip_term_cause>\n    <hangup_cause>NORMAL_CLEARING</hangup_cause>\n    <start_stamp>2009-02-23 23:15:08</start_stamp>\n    <profile_start_stamp>2009-02-23 23:15:08</profile_start_stamp>\n    <answer_stamp>2009-02-23 23:15:08</answer_stamp>\n    <progress_media_stamp>2009-02-23 23:15:08</progress_media_stamp>\n    <end_stamp>2009-02-23 23:15:30</end_stamp>\n    <start_epoch>1235423708</start_epoch>\n    <start_uepoch>1235423708386866</start_uepoch>\n    <profile_start_epoch>1235423708</profile_start_epoch>\n    <profile_start_uepoch>1235423708386866</profile_start_uepoch>\n    <answer_epoch>1235423708</answer_epoch>\n    <answer_uepoch>1235423708844601</answer_uepoch>\n    <progress_epoch>0</progress_epoch>\n    <progress_uepoch>0</progress_uepoch>\n    <progress_media_epoch>1235423708</progress_media_epoch>\n    <progress_media_uepoch>1235423708842794</progress_media_uepoch>\n    <end_epoch>1235423730</end_epoch>\n    <end_uepoch>1235423730722010</end_uepoch>\n    <last_app>voicemail</last_app>\n    <last_arg>default 62.149.27.151 1015</last_arg>\n    <caller_id>"1017" <1017></caller_id>\n    <duration>22</duration>\n    <billsec>22</billsec>\n    <progresssec>0</progresssec>\n    <progress_mediasec>0</progress_mediasec>\n    <flow_billsec>22</flow_billsec>\n    <mduration>22336</mduration>\n    <billmsec>21878</billmsec>\n    <progressmsec>0</progressmsec>\n    <progress_mediamsec>0</progress_mediamsec>\n    <flow_billmsec>22336</flow_billmsec>\n    <uduration>22335144</uduration>\n    <billusec>21877409</billusec>\n    <progressusec>0</progressusec>\n    <progress_mediausec>455928</progress_mediausec>\n    <flow_billusec>22335144</flow_billusec>\n    <sound_prefix>/usr/local/freeswitch/sounds/en/us/callie</sound_prefix>\n  </variables>\n  <app_log>\n    <application app_name="set" app_data="use_profile=default"></application>\n    <application app_name="set_user" app_data="default@62.149.27.151"></application>\n    <application app_name="info" app_data=""></application>\n    <application app_name="db" app_data="insert/62.149.27.151-spymap/1017/0c5bfef0-01ef-11de-ba5a-936aee2cf265"></application>\n    <application app_name="db" app_data="insert/62.149.27.151-last_dial/1017/1015"></application>\n    <application app_name="db" app_data="insert/62.149.27.151-last_dial/global/0c5bfef0-01ef-11de-ba5a-936aee2cf265"></application>\n    <application app_name="set" app_data="dialed_extension=1015"></application>\n    <application app_name="export" app_data="dialed_extension=1015"></application>\n    <application app_name="bind_meta_app" app_data="1 b s execute_extension::dx XML features"></application>\n    <application app_name="bind_meta_app" app_data="2 b s record_session::/usr/local/freeswitch/recordings/1017.2009-02-23-23-15-08.wav"></application>\n    <application app_name="bind_meta_app" app_data="3 b s execute_extension::cf XML features"></application>\n    <application app_name="set" app_data="ringback=%(2000, 4000, 440.0, 480.0)"></application>\n    <application app_name="set" app_data="transfer_ringback=local_stream://moh"></application>\n    <application app_name="set" app_data="call_timeout=30"></application>\n    <application app_name="set" app_data="hangup_after_bridge=true"></application>\n    <application app_name="set" app_data="continue_on_fail=true"></application>\n    <application app_name="db" app_data="insert/62.149.27.151-call_return/1015/1017"></application>\n    <application app_name="db" app_data="insert/62.149.27.151-last_dial_ext/1015/0c5bfef0-01ef-11de-ba5a-936aee2cf265"></application>\n    <application app_name="set" app_data="called_party_callgroup=techsupport"></application>\n    <application app_name="db" app_data="insert/62.149.27.151-last_dial/techsupport/0c5bfef0-01ef-11de-ba5a-936aee2cf265"></application>\n    <application app_name="bridge" app_data="user/1015@62.149.27.151"></application>\n    <application app_name="answer" app_data=""></application>\n    <application app_name="sleep" app_data="1000"></application>\n    <application app_name="voicemail" app_data="default 62.149.27.151 1015"></application>\n  </app_log>\n  <callflow dialplan="XML" profile_index="1">\n    <extension name="global" number="1015">\n      <application app_name="set" app_data="use_profile=${cond(${acl(${network_addr} rfc1918)} == true ? nat : default)}"></application>\n      <application app_name="set_user" app_data="default@${domain_name}"></application>\n      <application app_name="info" app_data=""></application>\n      <application app_name="db" app_data="insert/${domain_name}-spymap/${caller_id_number}/${uuid}"></application>\n      <application app_name="db" app_data="insert/${domain_name}-last_dial/${caller_id_number}/${destination_number}"></application>\n      <application app_name="db" app_data="insert/${domain_name}-last_dial/global/${uuid}"></application>\n      <application app_name="set" app_data="dialed_extension=1015"></application>\n      <application app_name="export" app_data="dialed_extension=1015"></application>\n      <application app_name="bind_meta_app" app_data="1 b s execute_extension::dx XML features"></application>\n      <application app_name="bind_meta_app" app_data="2 b s record_session::/usr/local/freeswitch/recordings/${caller_id_number}.${strftime(%Y-%m-%d-%H-%M-%S)}.wav"></application>\n      <application app_name="bind_meta_app" app_data="3 b s execute_extension::cf XML features"></application>\n      <application app_name="set" app_data="ringback=${us-ring}"></application>\n      <application app_name="set" app_data="transfer_ringback=local_stream://moh"></application>\n      <application app_name="set" app_data="call_timeout=30"></application>\n      <application app_name="set" app_data="hangup_after_bridge=true"></application>\n      <application app_name="set" app_data="continue_on_fail=true"></application>\n      <application app_name="db" app_data="insert/${domain_name}-call_return/${dialed_extension}/${caller_id_number}"></application>\n      <application app_name="db" app_data="insert/${domain_name}-last_dial_ext/${dialed_extension}/${uuid}"></application>\n      <application app_name="set" app_data="called_party_callgroup=${user_data(${dialed_extension}@${domain_name} var callgroup)}"></application>\n      <application app_name="db" app_data="insert/${domain_name}-last_dial/${called_party_callgroup}/${uuid}"></application>\n      <application app_name="bridge" app_data="user/${dialed_extension}@${domain_name}"></application>\n      <application app_name="answer" app_data=""></application>\n      <application app_name="sleep" app_data="1000"></application>\n      <application app_name="voicemail" app_data="default ${domain_name} ${dialed_extension}"></application>\n    </extension>\n    <caller_profile>\n      <username>1017</username>\n      <dialplan>XML</dialplan>\n      <caller_id_name>1017</caller_id_name>\n      <ani></ani>\n      <aniii></aniii>\n      <caller_id_number>1017</caller_id_number>\n      <network_addr>77.122.2.96</network_addr>\n      <rdnis></rdnis>\n      <destination_number>1015</destination_number>\n      <uuid>0c5bfef0-01ef-11de-ba5a-936aee2cf265</uuid>\n      <source>mod_sofia</source>\n      <context>default</context>\n      <chan_name>sofia/internal/1017@62.149.27.151</chan_name>\n    </caller_profile>\n    <times>\n      <created_time>1235423708386866</created_time>\n      <profile_created_time>1235423708386866</profile_created_time>\n      <progress_time>0</progress_time>\n      <progress_media_time>1235423708842794</progress_media_time>\n      <answered_time>1235423708844601</answered_time>\n      <hangup_time>1235423730722010</hangup_time>\n      <transfer_time>0</transfer_time>\n    </times>\n  </callflow></cdr>'}, HTTP_AUTHORIZATION=self.auth_string2)
        self.failUnlessEqual(response.status_code, 410)
        response = self.client.post('/api/cdr/', {'cdr': self.cdr2}, HTTP_AUTHORIZATION=self.auth_string3)
        self.failUnlessEqual(response.status_code, 401)


        response = self.client.post('/api/cdr/', {'cdr': self.cdr2}, HTTP_AUTHORIZATION=self.auth_string2)
        #log.debug(response)
        self.failUnlessEqual(response.status_code, 200)
        #response = self.client.post('/api/cdr/', {'cdr': self.cdr2}, HTTP_AUTHORIZATION=self.auth_string2)
        #self.failUnlessEqual(response.status_code, 200)



